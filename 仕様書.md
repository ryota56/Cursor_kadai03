project:
  name: "AIツール集約・実行プラットフォーム（ローカルMVP）"
  version: "0.2.1"  # [Fix] hydration-safe 対応版
  goal: "カード一覧 → ツール詳細フォーム → 生成（mock or Gemini） → 結果表示 をローカルで完結"
  scope:
    - ツール一覧（人気/新着タブ、検索）
    - ツール詳細（フォーム入力 → 生成 → 結果表示/コピー）
    - お気に入り（localStorage）
    - 履歴（localStorage）
  non_goals:
    - 認証/課金/分析（後続）
    - 本番DB（Supabaseは後続で接続）
    - 本格監視/運用

phases:
  mvp_phase_1 (最優先):
    - ツール一覧表示（人気/新着タブ＋検索）
    - ツール詳細・実行（mock生成）
    - UI/UXの骨格（レスポンシブ・ロード/エラー表示）
  mvp_phase_2 (次優先):
    - お気に入り機能（localStorage）
    - 履歴機能（localStorage）
    - Gemini連携（APIキー設定時のみ有効）
  later:
    - ページネーション/無限スクロール
    - 画像/音声/動画ツールの拡張
    - Supabase接続→GitHub→Vercelデプロイ

environment:
  node: ">=18"
  package_manager: "npm"
  os: "Windows/macOS/Linux"
  hydration_safe_rules:  # [Fix] 仕様レベルで明記
    - "SSR HTMLに『時刻・乱数・ロケール依存フォーマット』を埋めない（Date.now/Math.random/toLocaleStringをServerで使って描画しない）"
    - "localStorage等のブラウザAPIはClient Component内のuseEffectでのみアクセス"
    - "初期描画は決定的（deterministic）に。タブの初期値などは固定値"
    - "クライアントでのみ変化する表示（例：日時整形、履歴/お気に入り）は、マウント完了までSkeletonやプレースホルダを出す"
    - "Server ComponentからClient Componentへは安定したプリミティブpropsだけ渡す"
    - "suppressHydrationWarningは基本禁止（局所のspan限定で最終手段）"
  runbook:
    setup:
      - "npm create next-app@latest app --typescript --eslint --tailwind --src-dir --app --import-alias @/*"
      - "cd app"
      - "npx shadcn@latest init -y"
      - "npx shadcn@latest add button card input textarea select badge tabs alert toast skeleton separator"
      - "npm i @google/generative-ai"
      - "npm i -D @types/node"
    dev:
      - "npm run dev"
    env_files:
      - ".env.local（空でOK。Gemini利用時のみ GEMINI_API_KEY を設定）"
    dev_notes:  # [Fix] 開発時の実行手順に追記
      - "拡張機能による<body>改変を避けるため、検証はシークレットウィンドウで行う"

tech_stack:
  framework: "Next.js (App Router, TypeScript)"
  styling: "Tailwind CSS + shadcn/ui"
  state_management: "React Hooks（useState/useEffect）＋ localStorage"
  server:
    type: "Next.js Route Handlers（/app/api/*）"
    mode: "同期レスポンス（mock）。Gemini有効時はそのまま同期呼び出し"
  data_source:
    mode: "ローカルJSON（/data/*.json）+ メモリ保持"
  llm:
    provider_default: "mock"
    provider_optional: "Gemini（gemini-1.5-flash）"
    env_key: "GEMINI_API_KEY"
  deployment_future:
    db: "Supabase（Postgres/Storage）"
    hosting: "Vercel（GitHub連携）"

architecture:
  overview: "Next.js(Front+API) → mock/Gemini → (将来)Supabase"
  component_boundary:  # [Fix] Server/Client責務を明記
    server_components:
      - "app/(home)/page.tsx（一覧データ読取のみ：/data/tools.json）"
      - "app/tools/[slug]/page.tsx（ツール定義の静的取得のみ）"
      - "Breadcrumbsなど純表示系（入力なし）"
    client_components:
      - "FormRenderer（入力/バリデーション/送信）"
      - "ResultView（コピー、折りたたみ等の相互作用）"
      - "Favorites/History UI（localStorageアクセス）"
      - "ClientOnly/ClientMountProvider（マウント完了までのガード）"
  directories:
    - app/(home)/page.tsx
    - app/tools/[slug]/page.tsx
    - app/me/page.tsx
    - app/api/tools/route.ts
    - app/api/tools/[slug]/route.ts
    - app/api/tools/[slug]/runs/route.ts
    - components/cards/ToolCard.tsx
    - components/form/FormRenderer.tsx
    - components/result/ResultView.tsx
    - components/common/Breadcrumbs.tsx
    - components/providers/ClientOnly.tsx  # [Fix] 追加
    - components/providers/ClientMountProvider.tsx  # [Fix] 追加（mountedまではSkeleton）
    - lib/mock.ts
    - lib/llm.ts
    - lib/store.ts  # [Fix] localStorageラッパ（クライアント専用）
    - lib/utils.ts
    - data/tools.json
    - public/images/*
    - styles/globals.css

ui_ux:
  design_tokens:
    colors:
      primary: "indigo-600"
      accent: "purple-500"
      surface: "white"
      border: "gray-200"
      text_primary: "gray-900"
      text_secondary: "gray-600"
    radii: "rounded-2xl"
    shadows: "shadow-md"
    spacing: ["p-4", "p-6"]
  responsive_breakpoints (Tailwind):
    sm: "640px"
    md: "768px"
    lg: "1024px"
    xl: "1280px"
  components_shadcn (採用一覧):
    button: "生成/検索/お気に入り操作"
    card: "ツールカード/結果表示"
    input: "検索ボックス/単一行フィールド"
    textarea: "本文入力"
    select: "ツール種別（任意）"
    tabs: "人気/新着 切替"
    badge: "カテゴリ表示"
    alert: "フォームエラー/結果エラーの静的表示"
    toast: "成功/警告/失敗の瞬間通知"
    skeleton: "カード/フォーム/結果のローディング"
    separator: "セクション区切り"
  loading_states:
    skeletons:
      home_cards: "サムネ矩形+タイトル行+説明2行 × 6～9枚"
      detail_form: "ラベル行+入力欄×2、生成ボタンの灰ブロック"
      result: "本文3〜5行のプレースホルダ"
      client_mount: "履歴/お気に入り領域はマウント完了までSkeleton"  # [Fix]
    button_loading: "spinner + disabled"
  error_ui:
    patterns:
      field_error: "Input/textarea 下に赤テキスト＋aria-invalid"
      page_error: "Alert（タイトル/説明/再試行ボタン）"
      toast:
        success: "生成完了/コピー完了"
        warning: "入力が多すぎ/要約実施"
        error: "生成失敗/通信失敗/フォールバック使用"
  navigation_ui:
    header: ["ロゴ", "検索入力", "ヘルプ(外部リンク)", "設定(ダミー)"]
    breadcrumbs: true
    back_forward_buttons: "ツール詳細上部に＜戻る を表示（ブラウザ履歴依存）"
    search:
      placement: "ヘッダー右"
      behavior: "Enterで /?q= にクエリを付与、結果は一覧にフィルタ反映"
  accessibility:
    keyboard:
      - "Tab移動で全操作可能"
      - "Enter/Spaceで主要ボタン押下可"
    screen_reader:
      - "画像はalt必須"
      - "フォームラベルfor/id対応"
      - "Live regionでローディング/完了を通知（aria-live=polite）"
    contrast: "WCAG AA（4.5:1以上）"
    focus_ring: "Tailwind focus-visible を適用"

form_renderer:
  schema_source: "tool.form_schema_json"
  supported_fields:
    - name: "input"
      renders: "shadcn Input"
    - name: "textarea"
      renders: "shadcn Textarea"
    - name: "select"
      renders: "shadcn Select（options必須）"
    - name: "switch"
      renders: "shadcn Switch + Label"
  layout:
    grid: "12カラム（col:1-12）"
    gap: "gap-4"
  validation:
    engine: "軽量自前バリデーション（将来zod化）"
    rules:
      - "required: 未入力不可"
      - "maxLength: 超過時に警告（送信は許可、mockで要約）"
      - "type: input/select/textarea/switch の型検証"
    messages:
      required: "必須項目です"
      maxLength: "長すぎます（自動要約されます）"
  submit:
    button_label: "生成する"
    disabled_when: "バリデーションNG or 生成中"
  prompt_injection_guard (簡易):
    - "極端なシステムプロンプト挿入は警告表示"

data_persistence (localStorage):
  keys:
    favorites: "mvp_favorites_v2"
    history: "mvp_runs_v2"
    meta: "mvp_meta_v2"
  access_policy:  # [Fix] ここを厳密化
    - "lib/store.ts のみがlocalStorageに触れる単一の入口"
    - "読み書きはClient Component内のuseEffect経由。SSR中は一切アクセスしない"
    - "SSR初期HTMLでは、favorites/historyの実データは描画せず、ClientMountProviderで置換"
  structures:
    favorites (array):
      - toolSlug: "string"
        addedAt: "ISO8601"  # [Fix] 表示はクライアントでフォーマット（ロケール依存出力をSSRに含めない）
    history (array capped):
      max_items: 50
      item:
        id: "string (uuid)"
        toolSlug: "string"
        inputs: "Record<string,any>"
        output: "Record<string,any>"
        createdAt: "ISO8601"  # [Fix] 同上
    meta (object):
      version: 2
      migratedAt: "ISO8601"
  versioning_migration:
    policy:
      - "version不一致の場合、既存を読み込み→新構造へ変換→meta.version更新（※クライアントで実行）"  # [Fix]
      - "変換不可時はバックアップ保存（mvp_backup_yyyyMMdd）後に初期化"

api:
  endpoints:
    - method: "GET"
      path: "/api/tools"
      query: { order: "popular|latest", q: "string?" }
      success_200:
        body: { tools: "Tool[]" }
      error_500:
        body: { error: { code: "INTERNAL_ERROR", message: "string" } }
    - method: "GET"
      path: "/api/tools/[slug]"
      success_200:
        body: { tool: "Tool" }
      error_404:
        body: { error: { code: "TOOL_NOT_FOUND", message: "string" } }
    - method: "POST"
      path: "/api/tools/[slug]/runs"
      body: { inputs: "Record<string,any>", mode: "mock|gemini" }
      success_200:
        body: { runId: "string", output: "Record<string,any>" }
      error_400:
        body: { error: { code: "VALIDATION_ERROR", fields: "Record<string,string>" } }
      error_502:
        body: { error: { code: "LLM_UPSTREAM_ERROR", message: "string", fallback: "used|skipped" } }
  status_codes_usage:
    "200": "成功"
    "400": "クライアント入力エラー"
    "404": "リソース未検出"
    "500": "サーバ内部"
    "502": "LLM上流失敗"
  gemini_failure_fallback:
    - "Gemini失敗→mockで再生成→toast.warning + Alert（フォールバック）"
    - "両方失敗→toast.error + 再試行ボタン"

performance:
  images:
    next_image: true
    policy:
      - "public/imagesにwebp/avif優先"
      - "サムネは 480x320 目安"
  list_rendering:
    pagination: "Phase2で導入（10〜20件/ページ）"
    placeholder_count: 9
  bundle_budget:
    initial_js_kb: 200
    tactics:
      - "動的import（FormRenderer/ResultView）"
      - "shadcnの未使用コンポーネント削除"
      - "画像はCDN相当（ローカルはnext/image最適化）"

next_js_details:
  app_router:
    - "(home) で一覧"
    - "tools/[slug] で詳細"
    - "me で履歴/お気に入り"
  data_fetching:
    home: "ローカルJSONをサーバ側で読み取り（SSG）"
    detail: "slugでtools.jsonから抽出（SSG）"
  ssg_vs_ssr:  # [Fix] 明確化
    home: "SSG固定。ビルド時に生成"
    detail: "SSG固定。generateStaticParams使用可"
    me: "ページ本体はServerで枠だけ描画し、中身（履歴/お気に入り）はClientOnlyで後置換"  # [Fix]
  metadata (SEO):
    title_template: "%s | AIツールハブ"
    default_description: "文章・画像などのAIツールを素早く試せるMVP"
    open_graph_basic: true

typescript_types:
  files:
    - path: "types/tool.ts"
      content: |
        export type FieldKind = 'input' | 'textarea' | 'select' | 'switch';
        export type FieldOption = { label: string; value: string };
        export type Field = {
          name: string;
          label: string;
          kind: FieldKind;
          required?: boolean;
          help?: string;
          placeholder?: string;
          options?: FieldOption[];
          col?: number; // 1-12
          maxLength?: number;
        };
        export type ToolType = 'text' | 'image' | 'whisper' | 'movie';
        export type Tool = {
          id: number;
          slug: string;
          name: string;
          description?: string;
          type: ToolType;
          image_url?: string;
          usage_count: number;
          status: 'public' | 'draft';
          form_schema_json: Field[];
          prompt_template: string;
          created_at?: string; // ISO8601（表示整形はクライアント側）  # [Fix]
        };
        export type RunStatus = 'queued' | 'running' | 'succeeded' | 'failed';
        export type Run = {
          id: string;
          anon_id: string;
          toolSlug: string;
          inputs_json: Record<string, any>;
          output_json?: Record<string, any>;
          status: RunStatus;
          created_at: string; // ISO8601（表示整形はクライアント側）  # [Fix]
        };
    - path: "types/api.ts"
      content: |
        export type ApiError =
          | { code: 'VALIDATION_ERROR'; message?: string; fields?: Record<string,string> }
          | { code: 'TOOL_NOT_FOUND'; message: string }
          | { code: 'LLM_UPSTREAM_ERROR'; message: string; fallback: 'used' | 'skipped' }
          | { code: 'INTERNAL_ERROR'; message: string };

        export type GetToolsResponse = { tools: import('./tool').Tool[] };
        export type GetToolDetailResponse = { tool: import('./tool').Tool };
        export type PostRunRequest = { inputs: Record<string, any>; mode?: 'mock' | 'gemini' };
        export type PostRunResponse = { runId: string; output: Record<string, any> };

sample_data:
  files:
    - path: "/data/tools.json"
      content:
        tools:
          - id: 1
            slug: "rewrite"
            name: "文章をリライト"
            description: "既存文章を別表現に書き換えます。"
            type: "text"
            image_url: "/images/rewrite.png"
            usage_count: 239032
            status: "public"
            form_schema_json:
              - { name: "body", label: "書き直したい文章", kind: "textarea", required: true, help: "1000文字目安", placeholder: "", col: 12, maxLength: 8000 }
              - { name: "tone", label: "どのように書き直しますか？", kind: "input", required: false, help: "例: 初心者にも分かりやすく", placeholder: "丁寧・カジュアル など", col: 12, maxLength: 80 }
            prompt_template: |
              あなたはプロのライターです。
              次の文章を%s_tone%のトーンで、意味を保ちつつ表現を大きく変えてリライトしてください。
              # 制約:
              - 書き出しとゴール（結論）は同じ
              - 事実は改変しない
              # 文章:
              """%s_body%"""
          - id: 2
            slug: "tiktok-5picks"
            name: "【〇〇5選】TikTok台本メーカー"
            description: "渡されたテキストをもとに5つの要点台本に整理"
            type: "text"
            image_url: "/images/tiktok.png"
            usage_count: 128632
            status: "public"
            form_schema_json:
              - { name: "source", label: "元テキスト", kind: "textarea", required: true, help: "長すぎると要約されます", placeholder: "", col: 12, maxLength: 8000 }
            prompt_template: |
              次の内容を5つの要点に要約し、TikTok短尺向けの台本にしてください。
              # 出力仕様:
              1) 見出し
              - 本文（1〜2文）
              （×5個）
              # 入力:
              """%s_source%"""

routing:
  app_routes:
    - method: "GET"
      path: "/api/tools"
      desc: "ツール一覧（人気/新着/検索）"
    - method: "GET"
      path: "/api/tools/[slug]"
      desc: "ツール詳細（schema/prompt）"
    - method: "POST"
      path: "/api/tools/[slug]/runs"
      desc: "生成（mock or Gemini）"
  pages:
    home:
      route: "/"
      sections: ["ヘッダー", "検索", "タブ（人気/新着）", "カードグリッド", "フッタ"]
    tool_detail:
      route: "/tools/[slug]"
      sections: ["パンくず", "タイトル/説明/お気に入り", "フォーム", "生成ボタン", "結果"]
    my_page:
      route: "/me"
      sections: ["履歴一覧（再表示）", "お気に入り一覧（ClientOnlyでマウント後に出す）"]  # [Fix]

generation_logic:
  mock_text:
    algorithm:
      - "bodyを文分割→中心文抽出→冒頭/結論保持"
      - "tone が '丁寧/カジュアル/初心者向け' などなら語尾・接続詞マップで置換"
      - "最大長に収めるため要約（単純スコア）"
    output_shape:
      rewrite: { text: "string" }
      tiktok_5picks: { items: "Array<{title:string, body:string}>" }
  gemini_text:
    prompt_build: "prompt_template の %s_body% / %s_tone% を inputs で置換"
    call:
      model: "gemini-1.5-flash"
      temperature: 0.7
    output_parse: "text抽出→ResultViewへ"
  safeguards:
    - "空入力や同一入力の連打を抑制（debounce 500ms）"

error_handling:
  validations:
    - "必須未入力 → ボタンdisabled + フィールド下赤文"
    - "maxLength超過 → toast.warning + 自動要約許可"
  failures:
    - "LLM失敗/タイムアウト → 1回自動再試行（2秒）"
    - "再失敗 → mockフォールバック（通知）"
  ui_feedback:
    - "生成中：ボタンloading＋Skeleton表示"
    - "成功：toast.success（コピー時も）"
    - "失敗：toast.error（詳細はAlert展開）"

testing:
  unit:
    - "FormRenderer：schema→UI生成/必須/maxLength検証"
    - "mock生成：入力→出力形の保証"
  e2e:
    - "一覧→詳細→送信→結果→履歴保存→履歴再表示"
  manual_checklist:
    - "人気/新着タブ初期値が常に決定的（例：popular固定）"  # [Fix]
    - "localStorageはマウント後にのみ読み書き（Serverでは触らない）"  # [Fix]
    - "日時表示はすべてクライアントで整形（SSRでロケール依存文字列を出さない）"  # [Fix]
    - "レスポンシブ（sm/md/lg）での崩れ無"
    - "アクセシビリティ（キーボード操作/alt/ラベル）"
  acceptance_criteria:
    - "ホームでカード表示＋タブ/検索が機能"
    - "詳細でフォーム入力→生成→結果表示（mock）"
    - "履歴/お気に入りが保持される（v2スキーマ）"
    - "水和不一致の警告が出ない（拡張OFFの環境下）"  # [Fix]
    - "エラー/ロード表示が定義どおりに動作"

assets_preparation:
  images:
    - "public/images/rewrite.png（480x320, webp推奨）"
    - "public/images/tiktok.png（480x320, webp推奨）"
  placeholders:
    - "サムネ未設定時: /images/placeholder.webp"
  licensing_note: "ダミー画像は著作権クリアな素材を使用"

security_minimum_local:
  - "envは.gitignore、APIキーは.env.localのみに配置"
  - "Route Handlersでキーを直接クライアントへ返さない（Gemini呼び出しはサーバ側）"

notes_future_integration:
  supabase:
    - "DDLを移植（tools/runs/favorites）"
    - "RLSは匿名運用→後でAuth導入"
  deployment:
    - "GitHubへpush→Vercel接続→環境変数（GEMINI_API_KEY/SUPABASE_*）設定"
